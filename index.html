<!DOCTYPE html>
<html>
<head>
  <title>Micro:bit Live Data</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h1>Micro:bit Data</h1>
  <button id="connect">Tilslut Micro:bit</button>
  <pre id="output"></pre>

  <script>
    document.getElementById("connect").addEventListener("click", async () => {
      try {
        const port = await navigator.serial.requestPort();
        await port.open({ baudRate: 115200 });

        const decoder = new TextDecoderStream();
        const readableStreamClosed = port.readable.pipeTo(decoder.writable);

        // Her bruger vi LineBreakTransformer
        const reader = decoder.readable
          .pipeThrough(new TransformStream(new LineBreakTransformer()))
          .getReader();

        while (true) {
          const { value, done } = await reader.read();
          if (done) break;
          if (value) {
            const output = document.getElementById("output");
            output.textContent += value + "\n"; // tilfÃ¸j ny linje
            output.scrollTop = output.scrollHeight; // auto-scroll
          }
        }
      } catch (err) {
        console.error(err);
      }
    });

    // Helper der samler linjer
    class LineBreakTransformer {
      constructor() {
        this.container = '';
      }

      transform(chunk, controller) {
        this.container += chunk;
        const lines = this.container.split('\n');
        this.container = lines.pop(); // gem evt. halv linje
        lines.forEach(line => controller.enqueue(line));
      }

      flush(controller) {
        controller.enqueue(this.container);
      }
    }

    if (value.startsWith("light:")) {
      output.textContent += value + "\n";
      output.scrollTop = output.scrollHeight;
    }
  </script>
</body>
</html>
